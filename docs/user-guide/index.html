<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Guide - EOS Connect Documentation</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
</head>
<body>
    <!-- DRAFT BANNER - REMOVE WHEN FINALIZED -->
    <div class="draft-banner">
        <i class="fas fa-exclamation-triangle"></i> DRAFT DOCUMENTATION - UNDER REVIEW <i class="fas fa-exclamation-triangle"></i>
    </div>
    <!-- END DRAFT BANNER -->

    <nav class="nav-header">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">
                <img src="../assets/images/icon.png" alt="EOS Connect" style="height: 48px; vertical-align: middle; margin-right: 8px;">
                <span>EOS Connect</span>
                <span class="version-badge">v0.2.29</span>
            </a>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="../what-is/index.html">What Is</a></li>
                <li><a href="index.html" class="active">User Guide</a></li>
                <li><a href="configuration.html">Configuration</a></li>
                <li><a href="../advanced/index.html">Advanced</a></li>
                <li><a href="../developer/index.html">Developer</a></li>
                <li><a href="https://github.com/ohAnd/EOS_connect" target="_blank"><i class="fab fa-github"></i> GitHub</a></li>
                <li><a href="https://github.com/sponsors/ohAnd" target="_blank" title="Sponsor the project"><i class="fas fa-mug-hot"></i></a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Page wrapper with sidebar -->
        <div class="page-wrapper">
            <!-- Table of Contents Sidebar -->
            <aside class="toc-sidebar">
                <h3>On This Page</h3>
                <nav class="toc-nav">
                    <a href="#installation" class="toc-link">Quick Start</a>
                    <a href="#eos-requirements" class="toc-link">EOS Configuration</a>
                    <a href="#data-collection" class="toc-link">Data Collection</a>
                    <a href="#configuration" class="toc-link">Configuration</a>
                    <a href="#common-tasks" class="toc-link">Common Tasks</a>
                    <a href="#battery-pricing" class="toc-link">Battery Pricing</a>
                    <a href="#battery-overview" class="toc-link">Battery Overview</a>
                    <a href="#troubleshooting" class="toc-link">Troubleshooting</a>
                    <a href="#eos-server-setup" class="toc-link">EOS/EVopt Setup</a>
                </nav>
            </aside>

            <!-- Main content -->
            <main class="main-content">
        <div class="hero">
            <h1>User Guide</h1>
            <p>Install, configure, and use EOS Connect to bridge your energy system with optimization engines</p>
        </div>

        <!-- Quick Navigation -->
        <div class="main-blocks">
            <div class="block-card">
                <div class="card-header">
                    <div class="icon"><i class="fas fa-download"></i></div>
                    <h3>Installation</h3>
                </div>
                <p>Step-by-step guides for Home Assistant, Docker, and local installation</p>
                <a href="#installation" class="btn">Install →</a>
            </div>
            <div class="block-card">
                <div class="card-header">
                    <div class="icon"><i class="fas fa-cog"></i></div>
                    <h3>Configuration</h3>
                </div>
                <p>Complete configuration reference for config.yaml</p>
                <a href="configuration.html" class="btn">Configure →</a>
            </div>
            <div class="block-card">
                <div class="card-header">
                    <div class="icon"><i class="fas fa-desktop"></i></div>
                    <h3>Common Tasks</h3>
                </div>
                <p>Manual overrides, mode switching, and daily operations</p>
                <a href="#common-tasks" class="btn">View Tasks →</a>
            </div>
            <div class="block-card">
                <div class="card-header">
                    <div class="icon"><i class="fas fa-question-circle"></i></div>
                    <h3>Support</h3>
                </div>
                <p>Troubleshooting EOS connection and getting help</p>
                <a href="#eos-server-setup" class="btn">Get Help →</a>
            </div>
        </div>

        <!-- Quick Start -->
        <div class="content-section" id="installation">
            <h2><i class="fas fa-rocket"></i> Quick Start</h2>
            <p>Get EOS Connect running in 4 simple steps:</p>

            <h3>Step 1: Requirements</h3>
            <ul>
                <li><strong>Home Assistant</strong> (recommended for most users) OR</li>
                <li><strong>Docker</strong> with Docker Compose OR</li>
                <li><strong>Python 3.11+</strong> for local installation</li>
                <li><strong>Running EOS Server:</strong> You must have an instance of <a href="https://github.com/Akkudoktor-EOS/EOS" target="_blank">Akkudoktor EOS</a> or <a href="https://github.com/thecem/hassio-evopt" target="_blank">EVopt</a> already running and reachable</li>
            </ul>

            <h3>Step 2: Install</h3>
            
            <h4>Option A: Home Assistant Add-on (Recommended)</h4>
            <ol>
                <li>Add repository: <a href="https://github.com/ohAnd/ha_addons" target="_blank">ohAnd/ha_addons</a></li>
                <li>Install "EOS Server" add-on (or EVopt)</li>
                <li>Install "EOS Connect" add-on</li>
                <li>Configure both via HA UI</li>
                <li>Start both add-ons</li>
            </ol>

            <h4>Option B: Docker</h4>
            <pre><code>git clone https://github.com/ohAnd/EOS_connect.git
cd EOS_connect
docker-compose up --pull always -d</code></pre>

            <h4>Option C: Local Python</h4>
            <pre><code>git clone https://github.com/ohAnd/EOS_connect.git
cd EOS_connect
pip install -r requirements.txt
python src/eos_connect.py</code></pre>

            <h3>Step 3: Configure</h3>
            <p>Edit <code>src/config.yaml</code> with your system details:</p>
            <pre><code># Minimum configuration
eos:
  server: 192.168.1.94  # Your EOS server IP
  port: 8503
  time_frame: 900  # 15-minute intervals

battery:
  capacity_wh: 11059
  max_charge_power_w: 5000

pv_forecast:
  - name: myPV
    lat: 52.5200
    lon: 13.4050
    azimuth: 180
    tilt: 25
    power: 5000</code></pre>

            <h3>Step 4: Access Web Dashboard</h3>
            <p>Open your browser to:</p>
            <ul>
                <li><strong>Home Assistant:</strong> http://homeassistant.local:8081</li>
                <li><strong>Docker/Local:</strong> http://localhost:8081</li>
            </ul>

            <div class="alert alert-success">
                <strong><i class="fas fa-check-circle"></i> Success!</strong> You should see the EOS Connect dashboard with real-time data and forecasts.
            </div>
        </div>

        <!-- EOS Configuration Requirements -->
        <div class="content-section" id="eos-requirements">
            <h2><i class="fas fa-server"></i> EOS Configuration Requirements</h2>
            <p><strong>Important:</strong> EOS Connect requires specific prediction settings in your EOS instance. The default EOS configuration should work out-of-the-box, but verify these settings if you experience issues with forecasting.</p>

            <div class="alert alert-warning">
                <h4><i class="fas fa-exclamation-triangle"></i> Required EOS Prediction Settings</h4>
                <p>In your EOS <code>config.yml</code>, ensure these prediction parameters are configured:</p>
                <pre><code class="yaml"># EOS config.yml - Prediction and Optimization settings
prediction:
  # Prediction horizon (default: 48 hours)
  # EOS Connect requires at least 48 hours for proper optimization
  hours_ahead: 48
  
optimization:
  # Optimization horizon (default: 48 hours) 
  # Should match or be <= prediction hours_ahead
  hours_ahead: 48</code></pre>
            </div>

            <h3>What EOS Connect Handles</h3>
            <ul>
                <li><strong>Optimization Requests:</strong> EOS Connect sends optimization requests to EOS on a configurable interval (e.g., every 3 minutes)</li>
                <li><strong>No EOS Internal Scheduling:</strong> EOS Connect manages all timing - no internal EOS optimization intervals are used</li>
                <li><strong>48-Hour Forecasting:</strong> EOS Connect provides 48-hour load and PV forecasts to EOS for optimal decision making</li>
            </ul>

            <h3>Troubleshooting EOS Configuration</h3>
            <table>
                <thead>
                    <tr>
                        <th>Problem</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Short or no predictions</td>
                        <td>Verify <code>prediction.hours_ahead: 48</code> in EOS config</td>
                    </tr>
                    <tr>
                        <td>Optimization errors</td>
                        <td>Ensure <code>optimization.hours_ahead</code> is set to 48 or less than prediction horizon</td>
                    </tr>
                    <tr>
                        <td>EOS Connect timing issues</td>
                        <td>All optimization scheduling is handled by EOS Connect, not EOS internal timers</td>
                    </tr>
                </tbody>
            </table>

            <div class="alert alert-info">
                <strong><i class="fas fa-info-circle"></i> Note:</strong> The default EOS configuration typically includes these 48-hour settings. If you've customized your EOS config, ensure these values are properly set. For detailed EOS configuration, refer to the <a href="https://github.com/Akkudoktor-EOS/EOS#configuration" target="_blank">EOS documentation</a>.
            </div>
        </div>

        <!-- Data Collection -->
        <div class="content-section" id="data-collection">
            <h2><i class="fas fa-database"></i> Data Collection Requirements</h2>
            <p>EOS Connect collects historical load data from your smart home platform to create accurate forecasts for optimization.</p>

            <h3>How Data Collection Works</h3>
            <p>EOS Connect is a self-running system that periodically collects:</p>
            <ul>
                <li>Local energy consumption data (from Home Assistant or OpenHAB)</li>
                <li>PV solar forecasts for the next 48 hours</li>
                <li>Upcoming energy prices</li>
            </ul>

            <h3>Home Assistant Data Collection</h3>
            <p>Load data is retrieved using time-based averaging:</p>
            <ul>
                <li><strong>Today:</strong> One week ago, averaged with two weeks ago</li>
                <li><strong>Tomorrow:</strong> One week ago, averaged with two weeks ago</li>
                <li><strong>Car Load Adjustment:</strong> If an electric vehicle (EV) is/was connected, its load is subtracted from the household load to ensure accurate forecasting of non-EV energy consumption</li>
            </ul>

            <h4>Load Sensor Requirements</h4>
            <table>
                <thead>
                    <tr>
                        <th>Requirement</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Data Quality</td>
                        <td>Sensor must provide numeric values in unit <strong>watts</strong></td>
                    </tr>
                    <tr>
                        <td>Value Handling</td>
                        <td>Accepts both positive and negative values (all converted to absolute positive internally)</td>
                    </tr>
                    <tr>
                        <td>Sensor Type</td>
                        <td>Should represent <strong>overall net household consumption</strong>, including EV charge and optional loads</td>
                    </tr>
                </tbody>
            </table>

            <h4>Home Assistant Persistence Configuration</h4>
            <div class="alert alert-warning">
                <strong><i class="fas fa-exclamation-triangle"></i> Important:</strong> Home Assistant's default retention is only <strong>10 days</strong>. EOS Connect needs data from up to <strong>2 weeks ago</strong> for accurate forecasting.
            </div>

            <p>To extend retention, add this to your <code>configuration.yaml</code>:</p>
            <pre><code class="yaml"># configuration.yaml
recorder:
  purge_keep_days: 15  # Extend to 15 days minimum</code></pre>

            <p>After editing, restart Home Assistant. Note that longer retention requires more storage space.</p>

            <h3>OpenHAB Data Collection</h3>
            <p>Load data is retrieved from the last two days:</p>
            <ul>
                <li>From two days ago (00:00) to yesterday midnight</li>
                <li><strong>Car Load Adjustment:</strong> Similar to Home Assistant, the EV load is subtracted from the household load to isolate non-EV energy consumption</li>
            </ul>

            <p><em>Note: Detailed OpenHAB persistence configuration guidance will be added in a future update.</em></p>
        </div>

        <!-- Configuration Overview -->
        <div class="content-section" id="configuration">
            <h2><i class="fas fa-cog"></i> Configuration Overview</h2>
            <p>EOS Connect uses a YAML configuration file (<code>config.yaml</code>) with the following main sections:</p>

            <table>
                <thead>
                    <tr>
                        <th>Section</th>
                        <th>Purpose</th>
                        <th>Required</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>load</code></td>
                        <td>Configure household load data source</td>
                        <td>No (can use default)</td>
                    </tr>
                    <tr>
                        <td><code>eos</code></td>
                        <td>EOS/EVopt server connection</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td><code>price</code></td>
                        <td>Electricity price provider</td>
                        <td>No (can use default)</td>
                    </tr>
                    <tr>
                        <td><code>battery</code></td>
                        <td>Battery specifications and SOC source</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td><code>pv_forecast</code></td>
                        <td>Solar forecast configuration</td>
                        <td>Yes</td>
                    </tr>
                    <tr>
                        <td><code>inverter</code></td>
                        <td>Inverter control settings</td>
                        <td>No (can use default)</td>
                    </tr>
                    <tr>
                        <td><code>evcc</code></td>
                        <td>EV charging controller integration</td>
                        <td>No</td>
                    </tr>
                    <tr>
                        <td><code>mqtt</code></td>
                        <td>MQTT broker and Home Assistant settings</td>
                        <td>No</td>
                    </tr>
                </tbody>
            </table>

            <a href="configuration.html" class="btn-primary">Full Configuration Reference →</a>
        </div>

        <!-- Common Tasks -->
        <div class="content-section" id="common-tasks">
            <h2><i class="fas fa-edit"></i> Common Tasks</h2>
            <p>For a detailed breakdown of the dashboard interface, see the <a href="../what-is/index.html#web-dashboard">Dashboard Overview</a>.</p>

            <h3>Force Battery Charging from Grid</h3>
            <ol>
                <li>Open web dashboard</li>
                <li>Select "ChargeFromGrid" mode</li>
                <li>Set desired charge power (e.g., 3000 W)</li>
                <li>Set override duration (e.g., 02:00 for 2 hours)</li>
                <li>System will automatically return to Auto mode after duration</li>
            </ol>

            <h3>Switch to PV-Only Charging</h3>
            <ol>
                <li>Select "PVOnly" mode</li>
                <li>Battery will only charge from solar surplus</li>
                <li>Grid charging will be disabled</li>
            </ol>

            <h3>View Optimization Schedule</h3>
            <ol>
                <li>Check "Last Optimization" timestamp in dashboard</li>
                <li>View "Next Optimization" countdown</li>
                <li>Charts show planned battery SOC curve</li>
            </ol>
        </div>

        <!-- Battery Pricing -->
        <div class="content-section" id="battery-pricing">
            <h2><i class="fas fa-coins"></i> Battery Energy Pricing</h2>
            <p>EOS Connect can track the cost of energy stored in your battery in three different ways. Understanding which pricing mode you're using helps you understand optimization decisions.</p>
            <div class="alert alert-info">
                <strong><i class="fas fa-wand-magic-sparkles"></i> Automatic Sensor Detection:</strong> EOS Connect <strong>auto-detects</strong> your battery and grid sensor conventions (polarity) to correctly attribute charging energy to <strong>PV</strong> vs <strong>Grid</strong> — even if your grid sensor reports import as negative.
                <br>Check logs for: <code>[BATTERY-PRICE] Detected conventions: battery=... grid=...</code>
            </div>
            
            <h4>Three Battery Pricing Modes</h4>
            <p><strong>Mode 1: Fixed Static Price</strong> (Default)</p>
            <ul>
                <li>Battery energy cost set to a single fixed value (€/Wh)</li>
                <li>Simple but inaccurate - doesn't reflect actual charging sources</li>
                <li>Configuration: <code>battery.price_euro_per_wh_accu: 0.00004</code> (default)</li>
                <li>Use case: Quick setup when you don't have sensor data available</li>
            </ul>

            <p><strong>Mode 2: External Sensor-Based Price</strong></p>
            <ul>
                <li>Battery cost comes from a sensor you provide (e.g., from Home Assistant)</li>
                <li>Can be dynamically updated by external systems</li>
                <li>Configuration: <code>battery.price_euro_per_wh_sensor: sensor.battery_price</code></li>
                <li>Use case: Integration with other energy management systems that already calculate battery cost</li>
            </ul>

            <p><strong>Mode 3: Dynamic Historical Analysis (LIFO Inventory)</strong> - Recommended</p>
            <ul>
                <li>Analyzes actual charging history to determine real energy cost</li>
                <li>Automatically detects whether energy came from solar (PV) or grid</li>
                <li>Uses Last-In-First-Out (LIFO) inventory model for accurate current battery value</li>
                <li>Provides detailed charging session breakdown with costs</li>
                <li>Configuration: <code>battery.price_calculation_enabled: true</code></li>
                <li>Use case: Most accurate representation of stored energy value for optimization</li>
            </ul>

            <h4>Setting Up Dynamic Price Calculation (Recommended)</h4>
            <p>This mode automatically calculates the real cost of energy currently in your battery by forensically analyzing your charging history over the past 48-96 hours.</p>

            <h5>Step 1: Enable Dynamic Calculation</h5>
            <pre><code>battery:
  price_calculation_enabled: true  # Enable historical analysis
  price_update_interval: 900  # Update every 15 minutes (adjust as needed)
  price_history_lookback_hours: 96  # Analyze last 4 days (default: 96)</code></pre>

            <h5>Step 2: Configure Required Sensors</h5>
            <p>Dynamic calculation requires <strong>5 mandatory sensor feeds</strong> from your Home Assistant or OpenHAB:</p>
            <pre><code>battery:
  price_calculation_enabled: true
  
  # Real-time power sensors
  battery_power_sensor: sensor.battery_power        # Battery charge/discharge in W
  pv_power_sensor: sensor.total_pv_power           # Total PV generation in W
  grid_power_sensor: sensor.grid_power             # Grid import/export in W
  load_power_sensor: sensor.household_load         # Household consumption in W
  price_sensor: sensor.electricity_price           # Current market price in €/kWh or ct/kWh
  
  # Thresholds (adjust based on your system noise)
  charging_threshold_w: 50                         # Minimum power to count as "charging" event
  grid_charge_threshold_w: 100                     # Minimum grid import to attribute to grid vs PV</code></pre>

            <h5>Step 3: Verify Sensor Conventions</h5>
            <p><strong>Good news:</strong> You <em>do not</em> need to manually set sensor polarity. EOS Connect automatically detects and normalizes battery and grid conventions using an energy balance check:</p>
            <ul>
                <li><strong>Battery Power:</strong> <em>Auto-detected</em> (charging vs discharging sign)</li>
                <li><strong>Grid Power:</strong> <em>Auto-detected</em> (import vs export sign)</li>
                <li><strong>PV Power:</strong> Always positive (production)</li>
                <li><strong>Load Power:</strong> Always positive (consumption)</li>
                <li><strong>Price Sensor:</strong> €/kWh or ct/kWh — auto-detected</li>
            </ul>
            <div class="alert alert-warning">
                <strong><i class="fas fa-exclamation-triangle"></i> Troubleshooting:</strong> If you ever see grid charging attributed to PV at night (PV≈0), check the log lines for <code>PV≈0 but PV attribution occurred</code> and the detected conventions. This usually indicates inverted grid sensors — now automatically handled.
            </div>

            <h4>How Dynamic Calculation Works</h4>
            <ol>
                <li><strong>Event Detection:</strong> System scans your battery power history and identifies all periods where battery was charging (above threshold)</li>
                <li><strong>Source Attribution:</strong> For each charging period, compares PV generation vs grid import to determine energy source</li>
                <li><strong>Cost Assignment:</strong>
                    <ul>
                        <li>Energy from PV → valued at €0 (no per-kWh cost for solar generation)</li>
                        <li>Energy from Grid → valued at actual market price when charging occurred</li>
                    </ul>
                </li>
                <li><strong>Inventory Valuation (LIFO):</strong> Instead of averaging all sessions, uses Last-In-First-Out approach
                    <ul>
                        <li>Looks at most recent charging sessions</li>
                        <li>Works backward until reaching your current battery level</li>
                        <li>Results in accurate price reflecting the actual energy currently stored</li>
                    </ul>
                </li>
                <li><strong>Optimization Input:</strong> Final price is sent to optimizer so it knows when discharging is profitable</li>
            </ol>

            <h4>Viewing Battery Price Information</h4>
            <p>The Battery Overview screen shows detailed pricing information:</p>
            <ul>
                <li><strong>Stored Energy Price Card</strong> - Shows current calculated price in ct/kWh (cents per kilowatt-hour)</li>
                <li><strong>Price Label</strong> - Shows calculation method:
                    <ul>
                        <li>"Inventory Valuation" = Dynamic (LIFO) calculation</li>
                        <li>"External Sensor" = From sensor feed</li>
                        <li>"Fixed Value" = Static configured price</li>
                    </ul>
                </li>
                <li><strong>PV Share Card</strong> - Shows what percentage of stored energy came from solar vs grid</li>
                <li><strong>Recent Charging Sessions Chart</strong> - Visual timeline of charging events over analysis period</li>
                <li><strong>Detailed Session Table</strong> - Lists all detected charging sessions with:
                    <ul>
                        <li>Session timing</li>
                        <li>Total energy charged (kWh)</li>
                        <li>PV vs Grid breakdown</li>
                        <li>Cost of that session (€)</li>
                        <li><strong style="color: #4caf50;">Green highlight</strong> = Sessions currently in your inventory</li>
                    </ul>
                </li>
            </ul>

            <h4>Common Issues & Solutions</h4>
            <table>
                <thead>
                    <tr>
                        <th>Issue</th>
                        <th>Cause</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Price shows "--" or doesn't update</td>
                        <td>Missing required sensor or sensor not providing data</td>
                        <td>Verify all 5 sensors are configured and returning data in Home Assistant</td>
                    </tr>
                    <tr>
                        <td>No charging sessions found</td>
                        <td><code>charging_threshold_w</code> set too high for your system</td>
                        <td>Lower threshold to 25-50W depending on your battery system noise level</td>
                    </tr>
                    <tr>
                        <td>Sessions show 100% grid or 0% PV</td>
                        <td>Sensor convention incorrect or threshold settings wrong</td>
                        <td>Verify battery power sign convention; check grid/PV thresholds match your system</td>
                    </tr>
                    <tr>
                        <td>Price calculation disabled in logs</td>
                        <td><code>price_calculation_enabled: false</code> in config</td>
                        <td>Set to <code>true</code> in <code>config.yaml</code> and restart application</td>
                    </tr>
                </tbody>
            </table>

            <h4>Example Configuration</h4>
            <p>Complete example for Home Assistant with common sensor entities:</p>
            <pre><code>battery:
  source: homeassistant
  url: http://homeassistant:8123
  access_token: your_long_lived_access_token
  
  # Pricing configuration
  price_calculation_enabled: true  # Enable dynamic calculation
  price_update_interval: 900       # Update every 15 minutes
  price_history_lookback_hours: 96 # Analyze 4 days of history
  
  # Required sensors
  battery_power_sensor: sensor.battery_power
  pv_power_sensor: sensor.pv_total_power
  grid_power_sensor: sensor.grid_power
  load_power_sensor: sensor.home_load_power
  price_sensor: sensor.tibber_current_price
  
  # Thresholds
  charging_threshold_w: 50
  grid_charge_threshold_w: 100
  
  # Feed-in price (for valuing PV surplus energy)
  feed_in_price: 0.04  # €0.04/kWh when not charging from grid</code></pre>
        </div>

        <!-- Battery Overview -->
        <div class="content-section" id="battery-overview">
            <h2><i class="fas fa-battery-three-quarters"></i> Battery Overview</h2>
            <p>The Battery Overview section displays comprehensive information about your battery system, including temperature monitoring and charging status.</p>
            
            <h4>Battery Information Displayed</h4>
            <table>
                <thead>
                    <tr>
                        <th>Information</th>
                        <th>Description</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>State of Charge (SOC)</td>
                        <td>Current battery capacity as percentage (0-100%)</td>
                        <td>Determines available charge/discharge capacity</td>
                    </tr>
                    <tr>
                        <td>Max Charge Power</td>
                        <td>Current maximum charging power in kW</td>
                        <td>May be reduced due to temperature or SOC limits</td>
                    </tr>
                    <tr>
                        <td>Battery Temperature</td>
                        <td>Current battery temperature in °C</td>
                        <td>Displayed with status indicator and color code</td>
                    </tr>
                    <tr>
                        <td>Charge Duration</td>
                        <td>Estimated time to reach full capacity</td>
                        <td>Only shown when battery is charging</td>
                    </tr>
                </tbody>
            </table>

            <h4>Temperature Status Indicators</h4>
            <p>Battery temperature is displayed with visual indicators that show the battery's thermal status:</p>
            <ul>
                <li><strong style="color: #4a9eff;"><i class="fas fa-snowflake"></i> Cold (Blue Snowflake)</strong> - Temperature below 0°C
                    <ul>
                        <li>Cold protection active to prevent battery damage</li>
                        <li>Charging power may be reduced or disabled</li>
                        <li>Battery will warm up gradually during operation</li>
                    </ul>
                </li>
                <li><strong style="color: #ff9800;"><i class="fas fa-exclamation-circle"></i> Reduced Power (Orange Warning)</strong> - Temperature between 0-15°C or 45-55°C
                    <ul>
                        <li>Battery is outside optimal operating temperature range</li>
                        <li>Maximum charge power is reduced to protect battery lifespan</li>
                        <li>System will return to full power when temperature stabilizes in optimal range</li>
                    </ul>
                </li>
                <li><strong style="color: #4caf50;"><i class="fas fa-check-circle"></i> Optimal (Green Checkmark)</strong> - Temperature between 15-45°C
                    <ul>
                        <li>Battery is in ideal operating temperature range</li>
                        <li>Maximum charging power is available</li>
                        <li>No thermal restrictions applied</li>
                    </ul>
                </li>
                <li><strong style="color: #ff5252;"><i class="fas fa-fire"></i> Heat Protection (Red Fire)</strong> - Temperature above 55°C
                    <ul>
                        <li>Heat protection active to prevent battery damage</li>
                        <li>Charging power severely reduced or disabled</li>
                        <li>Ensure adequate ventilation around battery enclosure</li>
                    </ul>
                </li>
            </ul>

            <h4>Desktop vs Mobile View</h4>
            <p>The Battery Overview adapts its display based on screen size:</p>
            <ul>
                <li><strong>Desktop View</strong> - Full temperature display showing "Temp: 25.1°C" with status icon in the charging power section</li>
                <li><strong>Mobile View</strong> - Compact display showing temperature only when it affects charging power (e.g., "● 10.0kW | ❄ 5°C")</li>
                <li>Color codes remain consistent across all view sizes for quick recognition</li>
            </ul>

            <h4>Configuration</h4>
            <p>To monitor battery temperature, ensure the following is configured in your <code>config.yaml</code>:</p>
            <pre><code>battery:
  sensor_battery_temperature: sensor.your_battery_temp_sensor  # Required for temperature monitoring
  # Temperature threshold defaults (adjust if needed):
  # Cold protection: &lt; 0°C
  # Reduced power: 0-15°C or 45-55°C  
  # Optimal range: 15-45°C
  # Heat protection: &gt; 55°C</code></pre>
            <p>See <a href="configuration.html#battery-configuration">Battery Configuration</a> for detailed settings.</p>
        </div>

        <!-- Troubleshooting -->
        <div class="content-section" id="troubleshooting">
            <h2><i class="fas fa-wrench"></i> Troubleshooting</h2>
            <p>Common issues and solutions for EOS Connect.</p>

            <h3>Connection Issues</h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 200px;">Problem</th>
                        <th>Cause</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Connection refused</td>
                        <td>EOS server not running</td>
                        <td>Check EOS server status, verify it's running on configured port (8503 or 7050)</td>
                    </tr>
                    <tr>
                        <td>Timeout errors (optimization)</td>
                        <td>Server response too slow</td>
                        <td>Increase <code>eos.timeout</code> from 180 to 240+ seconds in config</td>
                    </tr>
                    <tr>
                        <td>Timeout errors (sensor data)</td>
                        <td>Home Assistant/OpenHAB response slow</td>
                        <td>Increase <code>request_timeout</code> from 10 to 20-30 seconds in config (especially on slower hardware like NAS devices)</td>
                    </tr>
                    <tr>
                        <td>Cannot reach dashboard</td>
                        <td>Port conflict or firewall</td>
                        <td>Check <code>eos_connect_web_port: 8081</code> is not in use, verify firewall rules</td>
                    </tr>
                </tbody>
            </table>

            <h3>Optimization Issues</h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 200px;">Problem</th>
                        <th>Cause</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>No predictions</td>
                        <td>EOS config missing prediction settings</td>
                        <td>Verify <code>prediction.hours_ahead: 48</code> in EOS <code>config.yml</code></td>
                    </tr>
                    <tr>
                        <td>Short predictions</td>
                        <td>Wrong prediction horizon</td>
                        <td>Check EOS config has <code>prediction.hours_ahead: 48</code></td>
                    </tr>
                    <tr>
                        <td>Optimization errors</td>
                        <td>Mismatched prediction/optimization</td>
                        <td>Ensure <code>optimization.hours_ahead</code> ≤ <code>prediction.hours_ahead</code> in EOS config</td>
                    </tr>
                    <tr>
                        <td>Wrong results</td>
                        <td>Incorrect EOS prediction mode</td>
                        <td>Verify EOS is in prediction mode, not simulation</td>
                    </tr>
                </tbody>
            </table>

            <h3>Data Collection Issues</h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 200px;">Problem</th>
                        <th>Cause</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Missing historical data</td>
                        <td>Home Assistant retention too short</td>
                        <td>Set <code>recorder.purge_keep_days: 15</code> in HA configuration.yaml</td>
                    </tr>
                    <tr>
                        <td>Sensor not found</td>
                        <td>Wrong entity ID or sensor offline</td>
                        <td>Check sensor name in HA/OpenHAB, verify sensor is providing data</td>
                    </tr>
                    <tr>
                        <td>Invalid sensor values</td>
                        <td>Sensor not in watts</td>
                        <td>Verify sensor unit is <strong>W</strong> (watts), not kW or other units</td>
                    </tr>
                </tbody>
            </table>

            <h3>Inverter Control Issues</h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 200px;">Problem</th>
                        <th>Cause</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Authentication failed (Fronius)</td>
                        <td>New firmware requires password reset</td>
                        <td>For firmware 1.38.6-1+, reset password in WebUI Settings → User Management</td>
                    </tr>
                    <tr>
                        <td>No inverter control</td>
                        <td>Type set to default</td>
                        <td>Set <code>inverter.type</code> to <code>fronius_gen24</code>, <code>evcc</code>, or appropriate type</td>
                    </tr>
                    <tr>
                        <td>EVCC not responding</td>
                        <td>Wrong URL or EVCC offline</td>
                        <td>Verify <code>evcc.url</code> points to running EVCC instance (e.g., http://192.168.1.100:7070)</td>
                    </tr>
                </tbody>
            </table>

            <h3>MQTT Integration Issues</h3>
            <table>
                <thead>
                    <tr>
                        <th style="width: 200px;">Problem</th>
                        <th>Cause</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>No MQTT messages</td>
                        <td>MQTT disabled or wrong broker</td>
                        <td>Set <code>mqtt.enabled: true</code>, verify broker address and credentials</td>
                    </tr>
                    <tr>
                        <td>HA entities not appearing</td>
                        <td>Auto discovery disabled</td>
                        <td>Set <code>mqtt.ha_mqtt_auto_discovery: true</code></td>
                    </tr>
                    <tr>
                        <td>Connection refused to broker</td>
                        <td>Wrong port or broker offline</td>
                        <td>Check broker is running, verify <code>mqtt.port</code> (default 1883)</td>
                    </tr>
                </tbody>
            </table>

            <h3>Getting Help</h3>
            <div class="alert alert-info">
                <h4><i class="fas fa-question-circle"></i> Still Need Help?</h4>
                <ul>
                    <li><strong>Logs:</strong> Check logs in dashboard (top menu → Logs) or enable <code>log_level: debug</code></li>
                    <li><strong>GitHub Issues:</strong> Search <a href="https://github.com/ohAnd/EOS_connect/issues" target="_blank">existing issues</a> or create a new one</li>
                    <li><strong>Discussions:</strong> Ask questions in <a href="https://github.com/ohAnd/EOS_connect/discussions" target="_blank">GitHub Discussions</a></li>
                    <li><strong>Documentation:</strong> Review <a href="configuration.html">Configuration Reference</a> and <a href="../advanced/index.html">Advanced Topics</a></li>
                </ul>
            </div>
        </div>

        <!-- EOS Server Setup -->
        <div class="content-section" id="eos-server-setup">
            <h2><i class="fas fa-desktop"></i> EOS/EVopt Server Setup</h2>
            <p><strong>EOS Connect requires a running optimization backend to calculate energy strategies.</strong></p>
            
            <div class="alert alert-info">
                <strong><i class="fas fa-lightbulb"></i> Remember:</strong> EOS Connect is an <strong>integration and control platform</strong>. The optimization calculations are performed by:
                <ul style="margin-top: 0.5rem;">
                    <li><strong>EOS</strong> - Akkudoktor Energy Optimization System (port 8503)</li>
                    <li><strong>EVopt</strong> - Lightweight optimizer (port 7050)</li>
                </ul>
            </div>

            <h3>Installing the Optimization Backend</h3>

            <h4>Option 1: Home Assistant Add-on</h4>
            <p>Install via Home Assistant add-on store:</p>
            <ul>
                <li><strong>EOS:</strong> <a href="https://github.com/Duetting/ha_eos_addon" target="_blank">Duetting/ha_eos_addon</a> or <a href="https://github.com/thecem/ha_eos_addon" target="_blank">thecem/ha_eos_addon</a></li>
                <li><strong>EVopt:</strong> <a href="https://github.com/thecem/hassio-evopt" target="_blank"><i class="fab fa-github"></i> thecem/hassio-evopt</a></li>
            </ul>

            <h4>Option 2: Docker</h4>
            <p>Run EOS in a separate Docker container (see EOS repository for docker-compose configuration).</p>

            <h4>Option 3: Local Installation</h4>
            <p>Clone and run EOS locally (requires Python). See <a href="https://github.com/Akkudoktor-EOS/EOS" target="_blank">EOS documentation</a>.</p>

            <h3>EOS Server Configuration</h3>
            <div class="alert alert-warning">
                <strong><i class="fas fa-exclamation-triangle"></i> Important:</strong> EOS must be configured for <strong>prediction mode</strong> with proper settings.
            </div>

            <h4>Required EOS Prediction Settings</h4>
            <p>In your EOS configuration, ensure these are set:</p>
            <pre><code>prediction_hours: 48
pv_prognose_today: 0.0
pv_prognose_tomorrow: 0.0
eauto: 0
gesamtlast: 0.0</code></pre>

            <h4>What EOS Connect Provides</h4>
            <p>EOS Connect automatically sends these values in optimization requests:</p>
            <ul>
                <li>PV forecasts (from your configured provider)</li>
                <li>Load predictions (from historical data or default profile)</li>
                <li>Current battery SOC</li>
                <li>Electricity price forecasts</li>
                <li>EVCC requirements (if configured)</li>
            </ul>

            <h3>Troubleshooting EOS Connection</h3>
            <ul>
                <li><strong>Connection refused:</strong> Check EOS server is running on configured port</li>
                <li><strong>Timeout:</strong> Increase <code>eos.timeout</code> in config (default 180s)</li>
                <li><strong>Wrong results:</strong> Verify EOS is in prediction mode, not using test data</li>
            </ul>

            <a href="#common-tasks" class="btn-primary">Common Tasks →</a>
        </div>

        <!-- Next Steps -->
        <div class="content-section">
            <h2><i class="fas fa-arrow-right"></i> Next Steps</h2>
            <div class="feature-grid">
                <div class="feature-item">
                    <a href="configuration.html" class="btn-primary">Full Configuration →</a>
                    <p>Detailed configuration for all features</p>
                </div>
                <div class="feature-item">
                    <a href="../advanced/index.html" class="btn-primary">Advanced Features →</a>
                    <p>MQTT, REST API, and automation</p>
                </div>
                <div class="feature-item">
                    <a href="#common-tasks" class="btn-primary">Common Tasks →</a>
                    <p>Learn how to perform manual actions</p>
                </div>
            </div>
        </div>
            </main>
        </div>
    </div>

    <footer class="footer">
        <p>EOS Connect Documentation | <a href="../index.html">Home</a> | <a href="https://github.com/ohAnd/EOS_connect">GitHub</a> | <a href="https://github.com/sponsors/ohAnd">Sponsor</a></p>
    </footer>

    <!-- Scroll spy for TOC -->
    <script>
        const sections = document.querySelectorAll('.content-section[id]');
        const tocLinks = document.querySelectorAll('.toc-link');

        function highlightTOC() {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        }

        window.addEventListener('scroll', highlightTOC);
        highlightTOC();
    </script>

    <!-- Back to Top Button -->
    <button class="back-to-top" onclick="scrollToTop()" aria-label="Back to top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <script>
function toggleMobileMenu() {
    const menu = document.querySelector('.nav-menu');
    menu.classList.toggle('mobile-active');
}

// Close mobile menu when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.querySelector('.nav-menu');
    const toggle = document.querySelector('.mobile-menu-toggle');
    if (menu.classList.contains('mobile-active') && !menu.contains(event.target) && !toggle.contains(event.target)) {
        menu.classList.remove('mobile-active');
    }
});
    </script>

    <script>
// Back to top button functionality
const backToTopButton = document.querySelector('.back-to-top');

window.addEventListener('scroll', function() {
    if (window.pageYOffset > 300) {
        backToTopButton.classList.add('visible');
    } else {
        backToTopButton.classList.remove('visible');
    }
});

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}
    </script>
</body>
</html>

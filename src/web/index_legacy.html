<!DOCTYPE html>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EOS connect board</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link rel="stylesheet" href="css/style_legacy.css">
    <link href="https://fonts.cdnfonts.com/css/seven-segment" rel="stylesheet">

</head>

<body>
    <div id="overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); color: white; display: flex; justify-content: center; align-items: center; z-index: 1000;">
        <div style="text-align: center; padding: 2em;">
            <p style="font-size: 2.5em; margin-bottom: 20px; text-align: center;">EOS connect</p>
            <p id="waiting_text" style="font-size: 1.5em; margin-bottom: 20px; text-align: center;">loading ...
            </p>
            <p id="waiting_error_text"
                style="font-size: 1.0em; font-weight: bold;  margin-bottom: 20px; text-align: center; color:rgb(241, 177, 0)">
                ...</p>
            <div
                style="border: 4px solid white; border-top: 4px solid gray; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto 0;">
            </div>
        </div>
        <div id="version_overlay"
            style="position: absolute; bottom: 10px; right: 10px; width: 100%; text-align: right; font-size: x-small;">
            EOS connect version: v00.00.00</div>
    </div>
    <div id="overlay_menu" style="display: none;">
        <div id="overlay_menu_content_wrapper" style="text-align: center; padding: 20px;">
            <p style="font-size: 1.8em; margin-bottom: 20px;">EOS connect</p>
            <hr>
            <p style="font-size: 1.3em; margin-bottom: 20px;" id="overlay_menu_head">Menu Overlay</p>
            <hr style="border-color: rgba(44, 44, 44, 0.596);">
            <p style="font-size: 1.2em; margin-bottom: 20px;" id="overlay_menu_content">This is a centered overlay menu.
            </p>
            <button id="overlay_menu_close" onclick="closeOverlayMenu(true)"
                style="padding: 10px 20px; font-size: 1em; background-color: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
        </div>
    </div>
    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <div class="container">
        <div class="top-boxes">
            <div class="top-box" id="current_controls_box">
                <div class="header"><i class="fa-solid fa-battery-full"></i> Current Controls
                    <span class="header_notification" id="current_header_left"
                        style="cursor: pointer;left: 10px;min-width: 20px;right: unset;">...</span>
                    <span class="header_notification" id="current_header_right"
                        style="cursor: pointer;min-width: 20px;">...</span>
                </div>
                <div class="content">
                    <table style="width: 100%; text-align: left;padding-top: 10px;">
                        <tr>
                            <th style="text-align: left;">Overall State</th>
                            <th style="text-align: right;" id="control_overall"></th>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <hr>
                            </td>
                        </tr>
                        <tr>
                            <td id="control_ac_charge_desc">AC Charge</td>
                            <td style="text-align: right;" id="control_ac_charge">--</td>
                        </tr>
                        <tr>
                            <td id="control_dc_charge_desc">DC Charge</td>
                            <td style="text-align: right;" id="control_dc_charge">--</td>
                        </tr>
                        <tr>
                            <td id="control_discharge_allowed_desc">Discharge Allowed</td>
                            <td style="text-align: right;" id="control_discharge_allowed">--</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="top-box">
                <div class="header"><i id="battery_icon_main"></i> Battery State
                    <span class="header_notification" id="battery_usable_capacity"
                        style="cursor: pointer;left: 10px;min-width: 20px;right: unset;">...</span>
                    <span class="header_notification" id="battery_soc" style="min-width: 20px;">...</span>
                </div>
                <div class="content">
                    <table style="width: 100%; text-align: left;padding-top: 10px;">
                        <tr id="next_charge_header">
                            <th style="text-align: left;">Next AC Charge</th>
                            <th style="text-align: right;" id="next_charge_time">... next charge time</th>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <hr>
                            </td>
                        </tr>
                        <tr id="next_charge_summary">
                            <td>Needed Energy</td>
                            <td colspan="2" style="text-align: right;"><span id="next_charge_amount">... kWh</span> /
                                <span id="next_charge_sum_price">... €</span>
                            </td>
                        </tr>
                        <tr id="next_charge_summary_2">
                            <td>Avg AC Charging Price</td>
                            <td colspan="2" style="text-align: right;" id="next_charge_avg_price">... kWh</td>
                        </tr>
                        <tr>
                            <td><i>Dynamic Max AC+DC Charge Power</i></td>
                            <td colspan="2" style="text-align: right;" id="current_max_charge_dyn">--</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="top-box">
                <div class="header"><i class="fa-solid fa-charging-station"></i> eCar Charging
                    <span class="header_notification" id="evcc_mode" style="left: 10px;right: unset;">...</span>
                    <span class="header_notification" id="evcc_state">...</span>
                </div>
                <div class="content" style="text-align: center;">
                    <span id="ecar_charging_table_off">no car connected</span>
                    <table style="width: 100%; text-align: left;padding-top: 10px;" id="ecar_charging_table_single">
                        <tr>
                            <!-- <th style="text-align: left;">Vehicle</th> -->
                            <th style="text-align: left; cursor: help;" colspan="2" title="name of vehicle in EVCC"><i
                                    class="fa-solid fa-car"></i> <span id="ecar_charging_name">...</span></th>
                            <!-- <th style="text-align: right;">SOC </th> -->
                            <th class="valueChange" style="text-align: right; cursor: help;" colspan="2"
                                title="eCar SOC"><span id="ecar_charging_soc">--.- %</span> <i
                                    class="fa-solid fa-car-battery"></i></th>
                        </tr>
                        <tr>
                            <td colspan="4">
                                <hr>
                            </td>
                        </tr>
                        <tr>
                            <td style="text-align: right; cursor: help;" class="valueChange" id="ecar_charging_odometer"
                                title="current vehicle mileage">--- km</td>
                            <td style="text-align: right;"><i class="fa-solid fa-gauge"> </i></td>
                            <td style="text-align: left; border-left-width: 1px; border-left-style: solid;"> <i
                                    class="fa-solid fa-road"></i></td>
                            <td style="text-align: left; cursor: help;" class="valueChange" style="text-align: right;"
                                id="ecar_charging_range" title="current vehicle range">--- km</td>
                        </tr>
                        <tr>
                            <td style="text-align: right; cursor: help;" class="valueChange" id="ecar_charging_charged"
                                title="already charged energy">0.00 kWh</td>
                            <td style="text-align: right;"><i class="fa-solid fa-right-long"> <i
                                        class="fa-solid fa-bolt"> </i></td>
                            <td style="text-align: left; border-left-width: 1px; border-left-style: solid;"> <i
                                    class="fa-solid fa-bolt"> </i> <i class="fa-solid fa-check"></i></td>
                            <td style="text-align: left; cursor: help;" class="valueChange"
                                id="ecar_charging_charged_remain" title="remaining energy to charge">0.00
                                kWh</td>
                        </tr>
                        <tr>
                            <td style="text-align: right; cursor: help;" class="valueChange" id="ecar_charging_duration"
                                title="current duration of charging">00:00</td>
                            <td style="text-align: right;"><i class="fa-solid fa-right-long"></i> <i
                                    class="fa-solid fa-stopwatch"></i> </td>
                            <td style="text-align: left; border-left-width: 1px; border-left-style: solid;"> <i
                                    class="fa-solid fa-clock"></i> <i class="fa-solid fa-check"></i></td>
                            <td style="text-align: left; cursor: help;" class="valueChange"
                                id="ecar_charging_duration_remain" title="remaining time until charging is done">00:00
                            </td>
                        </tr>
                    </table>
                    <table style="width: 100%; text-align: left;padding-top: 10px;" id="ecar_charging_table_multiple">
                        <!-- will be filled with multiple vehicles -->
                    </table>
                </div>
            </div>
            <div class="top-box">
                <div class="header"><i class="fa-solid fa-chart-pie"></i> Statistics
                    <span class="header_notification" id="statistics_header_left"
                        style="cursor: pointer;left: 10px;min-width: 20px;right: unset;">...</span>
                    <span class="header_notification" id="statistics_header_right" style="min-width: 20px;">...</span>
                </div>
                <div class="content">
                    <table style="width: 100%; text-align: left;padding-top: 10px;">
                        <tr>
                            <th style="text-align: left;">Expense (rest of the day)</th>
                            <th style="text-align: right;" id="expense_summary"> 0.00 €</th>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <hr>
                            </td>
                        </tr>
                        <tr>
                            <td>Income</td>
                            <td colspan="2" style="text-align: right;" id="income_summary">0.00 €</td>
                        </tr>
                        <tr>
                            <td>Feed In</td>
                            <td colspan="2" style="text-align: right;" id="feed_in_summary">0.0 kWh</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="bottom-boxes">
            <div class="left-box">
                <div class="header"><i class="fa-solid fa-chart-column"></i> Optimization
                    <span class="header_notification" id="timestamp_next_run"
                        style="left: 10px;right: unset;">00:00:00</span>
                    <span class="header_notification" id="mobileview_rotate"
                        style="right: 6.0em; background-color: inherit;"
                        title="Rotate your device to landscape for a better view">
                        <i class="fa-solid fa-mobile-screen-button"></i> <i class="fa-solid fa-rotate"></i>
                    </span>
                    <span class="header_notification" id="timestamp_last_run">00:00:00</span>
                </div>
                <div class="content">
                    <canvas id="energyChart"></canvas>
                </div>
            </div>
            <div class="right-box">
                <div class="header"><i class="fa-solid fa-calendar-days"></i><span id="load_schedule_header"> Schedule
                        next 24 hours</span></div>
                <div class="content">
                    <div id="discharge_scheduler" class="table">
                        <div class="table-header">
                            <div class="table-row">
                                <div class="table-cell">time</div>
                                <div class="table-cell">Control<br><i style="font-size: smaller;"></i>target state</i>
                                </div>
                                <div class="table-cell">Price<br><i style="font-size: smaller;">ct/kWh</i></div>
                                <div class="table-cell">Expense<br><i style="font-size: smaller;">€</i></div>
                                <div class="table-cell">Income<br><i style="font-size: smaller;">€</i></div>
                            </div>
                        </div>
                        <div class="table-row">
                            &nbsp;
                        </div>
                        <div class="table-body">
                            <div class="table-row">
                                <div class="table-cell">Data 1</div>
                                <div class="table-cell">Data 2</div>
                                <div class="table-cell">Data 3</div>
                                <div class="table-cell">Data 4</div>
                                <div class="table-cell">Data 5</div>
                            </div>
                            <div class="table-row">
                                <div class="table-cell">Data 5</div>
                                <div class="table-cell">Data 6</div>
                                <div class="table-cell">Data 7</div>
                                <div class="table-cell">Data 8</div>
                                <div class="table-cell">Data 9</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        /*
         * TIME HANDLING STRATEGY
         * ======================
         * 
         * SERVER TIME: Used for all data processing and calculations (from data_response["timestamp"])
         * USER TIME: Used for display - chart labels and schedule show in user's local timezone
         * 
         * This allows users in different timezones to see when events happen in their local time
         * while maintaining consistent server-based data processing.
         */
        const TEST_MODE = false;
        if (TEST_MODE) {
            document.body.style.backgroundColor = 'lightgreen';
        }

        let max_charge_power_w = 0;
        let inverter_mode_num = -1;
        let chartInstance = null;
        let menuControlEventListener = null;

        const COLOR_MODE_CHARGE_FROM_GRID = "rgb(255, 144, 144)";
        const COLOR_MODE_AVOID_DISCHARGE = "lightgray";
        const COLOR_MODE_DISCHARGE_ALLOWED = "lightgreen";
        const COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST = "#3399FF";
        const COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV = "lightgreen";
        const COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV = "darkorange";


        function isMobile() {
            return window.innerWidth <= 768;
        }

        function updateLegendVisibility() {
            if (chartInstance) {
                chartInstance.options.plugins.legend.display = !isMobile();
                if (!chartInstance.options.scales.y.ticks.font)
                    chartInstance.options.scales.y.ticks.font = {};
                chartInstance.options.scales.y.ticks.font.size = isMobile() ? 8 : 12; // Adjust font size based on screen size

                if (!chartInstance.options.scales.y1.ticks.font)
                    chartInstance.options.scales.y1.ticks.font = {};
                chartInstance.options.scales.y1.ticks.font.size = isMobile() ? 8 : 12; // Adjust font size based on screen size
                if (!chartInstance.options.scales.y2.ticks.font)
                    chartInstance.options.scales.y2.ticks.font = {};
                chartInstance.options.scales.y2.ticks.font.size = isMobile() ? 8 : 12; // Adjust font size based on screen size
                if (!chartInstance.options.scales.x.ticks.font)
                    chartInstance.options.scales.x.ticks.font = {};
                chartInstance.options.scales.x.ticks.font.size = isMobile() ? 8 : 12; // Adjust font size for x-axis based on screen size
                chartInstance.options.scales.y.title.display = !isMobile();
                chartInstance.options.scales.y1.title.display = !isMobile();
                chartInstance.options.scales.y2.title.display = !isMobile();

                chartInstance.update();
            }
        }
        window.addEventListener('resize', updateLegendVisibility);
        updateLegendVisibility();

        function writeIfValueChanged(id, value) {
            const element = document.getElementById(id);
            if (element.innerText !== value) {
                element.innerText = value;
                element.classList.add('valueChange');
                setTimeout(() => {
                    element.classList.remove('valueChange');
                }, 1000); // Remove the class after 1 second
            }
        }

        function overlayMenu(header, content, close = true) {
            const overlay = document.getElementById('overlay_menu');
            if (overlay.style.display === 'none') {
                overlay.style.display = 'flex';
                document.getElementById('overlay_menu_head').innerHTML = header;
                document.getElementById('overlay_menu_content').innerHTML = content;
                document.getElementById('overlay_menu_close').style.display = close ? '' : 'none';
            }
        }

        function closeOverlayMenu(direct = true) {
            const overlay = document.getElementById('overlay_menu');
            if (overlay.style.display === 'flex') {
                if (direct) {
                    overlayMenu('', '', false);
                    overlay.style.display = 'none';
                } else {
                    overlay.style.transition = 'opacity 1s';
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlayMenu('', '', false);
                        overlay.style.display = 'none';
                        overlay.style.opacity = '1';
                    }, 250);
                }
            }
        }

        function getBatteryIcon(soc_value) {
            if (soc_value > 90) {
                return '<i class="fa-solid fa-battery-full"></i>';
            } else if (soc_value > 70) {
                return '<i class="fa-solid fa-battery-three-quarters"></i>';
            } else if (soc_value > 50) {
                return '<i class="fa-solid fa-battery-half"></i>';
            } else if (soc_value > 30) {
                return '<i class="fa-solid fa-battery-quarter"></i>';
            } else {
                return '<i class="fa-solid fa-battery-empty"></i>';
            }
        }

        async function fetch_eos_ha_Data(filename) {
            const response = await fetch('json/' + filename + '?nocache=' + new Date().getTime());
            const data = await response.json();
            return data;
        }

        function updateChart(data_request, data_response) {
            // Use server timestamp consistently for data processing
            const serverTime = new Date(data_response["timestamp"]);
            const currentHour = serverTime.getHours();

            // Create labels in user's local timezone - showing only hours with :00
            chartInstance.data.labels = Array.from({ length: data_response["result"]["Last_Wh_pro_Stunde"].length },
                (_, i) => {
                    // Create a new date object for each hour label in user's timezone
                    const labelTime = new Date(serverTime.getTime() + (i * 60 * 60 * 1000));
                    const hour = labelTime.getHours();
                    return `${hour.toString().padStart(2, '0')}:00`;
                });

            // Calculate consumption (excluding home appliances)
            chartInstance.data.datasets[0].data = data_response["result"]["Last_Wh_pro_Stunde"].map((value, index) => {
                const actHomeApplianceValue = data_response["result"]["Home_appliance_wh_per_hour"].map(value => value)
                return ((value - actHomeApplianceValue[index]) / 1000).toFixed(3);
            });

            // Home appliances
            chartInstance.data.datasets[1].data = data_response["result"]["Home_appliance_wh_per_hour"].map(value => (value / 1000).toFixed(3));

            // PV forecast
            chartInstance.data.datasets[2].data = data_request["ems"]["pv_prognose_wh"].slice(currentHour).concat(data_request["ems"]["pv_prognose_wh"].slice(24, 48)).map(value => (value / 1000).toFixed(3));

            // Prepare arrays for grid and AC charge with redistribution logic
            const gridData = [];
            const acChargeData = [];

            data_response["result"]["Netzbezug_Wh_pro_Stunde"].forEach((value, index) => {
                const originalAcChargeValue = data_response["ac_charge"].slice(currentHour).concat(data_response["ac_charge"].slice(24, 48))[index] * max_charge_power_w;
                let gridValue = (value - originalAcChargeValue) / 1000;
                let adjustedAcChargeValue = originalAcChargeValue / 1000;

                // Validation for invalid numbers
                if (isNaN(gridValue) || !isFinite(gridValue)) {
                    console.warn(`Invalid grid calculation at index ${index}: Netzbezug=${value}, AC_charge=${originalAcChargeValue}, using 0 for grid`);
                    gridValue = 0;
                    adjustedAcChargeValue = (value / 1000); // Treat all as AC charge
                }
                // If calculated grid value would be negative, show actual grid data and planned AC charge
                else if (gridValue < 0) {
                    console.info(`Negative calculated grid at index ${index}: ${gridValue.toFixed(3)}kW, showing actual Netzbezug=${(value / 1000).toFixed(3)}kW and planned AC charge=${(originalAcChargeValue / 1000).toFixed(3)}kW`);
                    // Show actual grid consumption/feed-in from Netzbezug_Wh_pro_Stunde
                    gridValue = value / 1000;
                    // Show planned AC charge
                    adjustedAcChargeValue = originalAcChargeValue / 1000;
                }

                gridData.push(gridValue.toFixed(3));
                acChargeData.push(adjustedAcChargeValue.toFixed(3));
            });

            // Set the calculated data
            chartInstance.data.datasets[3].data = gridData; // Grid consumption
            chartInstance.data.datasets[4].data = acChargeData; // AC charging (adjusted)

            // Rest of the datasets remain unchanged
            chartInstance.data.datasets[5].data = data_response["result"]["akku_soc_pro_stunde"];
            chartInstance.data.datasets[6].data = data_response["result"]["Kosten_Euro_pro_Stunde"];
            chartInstance.data.datasets[7].data = data_response["result"]["Einnahmen_Euro_pro_Stunde"];
            chartInstance.data.datasets[8].data = data_response["result"]["Electricity_price"].map(value => value * 1000);
            chartInstance.data.datasets[9].data = data_response["discharge_allowed"].slice(currentHour).concat(data_response["discharge_allowed"].slice(24, 48));

            chartInstance.update('none'); // Update without animation
        }

        function createChart(data_request, data_response) {
            const ctx = document.getElementById('energyChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Load', data: [], backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1, stack: 'load' },
                        { label: 'Home Appliance', data: [], backgroundColor: 'rgba(172, 41, 0, 0.4)', borderColor: 'rgba(172, 41, 0, 1)', borderWidth: 1, stack: 'load' },
                        { label: 'PV forecast', data: [], backgroundColor: '#FFA500', borderColor: '#FF991C', borderWidth: 1, stack: 'combined' },
                        { label: 'Grid', data: [], backgroundColor: 'rgba(128, 128, 128, 0.6)', borderColor: 'rgba(211, 211, 211, 0.7)', borderWidth: 1, stack: 'combined' },
                        { label: 'AC Charge', data: [], backgroundColor: 'darkred', borderColor: 'rgba(255, 0, 0, 0.2)', borderWidth: 1, stack: 'combined' },
                        { label: 'Akku SOC', data: [], type: 'line', backgroundColor: 'blue', borderColor: 'lightblue', borderWidth: 1, yAxisID: 'y2' },
                        { label: 'Expense', data: [], type: 'line', borderColor: 'lightgreen', backgroundColor: 'green', borderWidth: 1, yAxisID: 'y1', stepped: true, hidden: true },
                        { label: 'Income', data: [], type: 'line', borderColor: 'lightyellow', backgroundColor: 'yellow', borderWidth: 1, yAxisID: 'y1', stepped: true, hidden: true },
                        { label: 'Electricity Price', data: [], type: 'line', borderColor: 'rgba(255, 69, 0, 0.8)', backgroundColor: 'rgba(255, 165, 0, 0.2)', borderWidth: 1, yAxisID: 'y1', stepped: true },
                        //{ label: 'Discharge Allowed', data: [], type: 'line', borderColor: 'lightblue', backgroundColor: 'rgba(255, 255, 255, 0.05)', borderWidth: 0, fill: true, yAxisID: 'y3' }
                        { label: 'Discharge Allowed', data: [], type: 'line', borderColor: 'rgba(144, 238, 144, 0.3)', backgroundColor: 'rgba(144, 238, 144, 0.05)', borderWidth: 1, fill: true, yAxisID: 'y3' }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Energy (kWh)', color: 'lightgray' }, grid: { color: 'rgb(54, 54, 54)' }, ticks: { color: 'lightgray' } },
                        y1: { beginAtZero: true, position: 'right', title: { display: true, text: 'Price (€)', color: 'lightgray' }, grid: { drawOnChartArea: false }, ticks: { color: 'lightgray', callback: value => value.toFixed(2) } },
                        y2: { beginAtZero: true, position: 'right', title: { display: true, text: 'Akku SOC (%)', color: 'darkgray' }, grid: { drawOnChartArea: false }, ticks: { color: 'darkgray', callback: value => value.toFixed(0) } },
                        y3: { beginAtZero: true, position: 'right', display: false, title: { display: true, text: 'AC Charge', color: 'darkgray' }, grid: { drawOnChartArea: false }, ticks: { color: 'darkgray', callback: value => value.toFixed(2) } },
                        x: { grid: { color: 'rgb(54, 54, 54)' }, ticks: { color: 'lightgray', font: { size: 10 } } }
                    },
                    plugins: {
                        legend: { display: !isMobile(), labels: { color: 'lightgray' } }
                    },
                }
            });
            updateChart(data_request, data_response); // Feed the content immediately after creation
        }

        function setBatteryChargingData(data_response) {
            // planned charging
            var currentHour = new Date(data_response["timestamp"]).getHours(); // ✅ Use server time
            price_data = data_response["result"]["Electricity_price"];
            ac_charge = data_response["ac_charge"];
            //ac_charge = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            var next_charge_time = ac_charge.slice(currentHour).findIndex((value) => value > 0);
            if (next_charge_time !== -1) {
                next_charge_time += currentHour;
                var next_charge_time_hour = next_charge_time % 24;
                document.getElementById('next_charge_time').innerText = next_charge_time_hour + ":00";
            } else {
                document.getElementById('next_charge_time').innerText = "--:--";
            }

            // calculate the average price for the next charging hours based on ac_charge
            // and calculate the next charge amount
            var next_charge_amount = 0;
            let total_price = 0;
            let total_price_count = 0;
            var foundFirst = false;
            for (let index = 0; index < ac_charge.slice(currentHour).length; index++) {
                const value = ac_charge[currentHour + index];

                if (value > 0) {
                    if (!foundFirst) {
                        foundFirst = true;
                    }
                    let current_hour_amount = value * max_charge_power_w;
                    let current_hour_price = price_data[index] * current_hour_amount; // Convert to ct/kWh
                    total_price += current_hour_price;
                    total_price_count += 1;
                    next_charge_amount += value * max_charge_power_w;
                } else if (foundFirst) {
                    break; // Stop the loop once a 0 is encountered after the first non-zero value
                }
            }

            let next_charge_avg_price = total_price / next_charge_amount * 100000;

            if (next_charge_amount === 0) {
                //document.getElementById('next_charge_header').style.display = "none";
                document.getElementById('next_charge_time').innerText = "not planned";
                document.getElementById('next_charge_summary').style.display = "none";
                document.getElementById('next_charge_summary_2').style.display = "none";

            } else {
                document.getElementById('next_charge_amount').innerText = (next_charge_amount / 1000).toFixed(1) + " kWh";
                // next_charge_sum_price
                document.getElementById('next_charge_sum_price').innerText = total_price.toFixed(2) + " €";

                if (next_charge_time !== -1) {
                    document.getElementById('next_charge_avg_price').innerText = (next_charge_avg_price).toFixed(1) + " ct/kWh";
                }

                document.getElementById('next_charge_header').style.display = "";
                document.getElementById('next_charge_summary').style.display = "";
                document.getElementById('next_charge_summary_2').style.display = "";
            }
        }

        function getChargingColorAndText(evcc_mode, evcc_state) {
            let color = "white";
            let text = "N/A";

            if (evcc_mode === "off") {
                text = "Off";
            } else if (evcc_mode === "pv") {
                text = "PV";
                if (evcc_state) {
                    color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV;
                }
            } else if (evcc_mode === "minpv") {
                text = "Min+PV";
                if (evcc_state) {
                    color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV;
                }
            } else if (evcc_mode === "now") {
                text = "Fast charge";
                if (evcc_state) {
                    color = COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST;
                }
            } else if (evcc_mode === "pv+now" || evcc_mode === "minpv+now") {
                text = "Smart Cost Fast";
                if (evcc_state) {
                    color = COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST;
                }
            }

            return { color, text };

        }

        function showSingleLoadpoint(session) {
            document.getElementById('ecar_charging_table_single').style.display = "";
            document.getElementById('ecar_charging_table_multiple').style.display = "none";
            document.getElementById('ecar_charging_table_off').style.display = "none";

            displayName = session["vehicleName"] || "Unknown Vehicle";
            if (displayName.length > 25)
                displayName = displayName.substring(0, 25) + "...";

            writeIfValueChanged('ecar_charging_name', displayName);
            writeIfValueChanged('ecar_charging_soc', (session["vehicleSoc"]).toFixed(1) + " %");
            writeIfValueChanged('ecar_charging_odometer', session["vehicleOdometer"] + " km");
            writeIfValueChanged('ecar_charging_range', session["vehicleRange"] + " km");
            writeIfValueChanged('ecar_charging_charged', (session["chargedEnergy"] / 1000).toFixed(1) + " kWh");
            writeIfValueChanged('ecar_charging_charged_remain', (session["chargeRemainingEnergy"] / 1000).toFixed(1) + " kWh");
            let chargeDuration = session["chargeDuration"];
            let hours = Math.floor(chargeDuration / 3600);
            let minutes = Math.floor((chargeDuration % 3600) / 60);
            writeIfValueChanged('ecar_charging_duration', hours.toString().padStart(2, '0') + ":" + minutes.toString().padStart(2, '0'));
            let chargeRemainingDuration = session["chargeRemainingDuration"];
            let remainingHours = Math.floor(chargeRemainingDuration / 3600);
            let remainingMinutes = Math.floor((chargeRemainingDuration % 3600) / 60);
            writeIfValueChanged('ecar_charging_duration_remain', remainingHours.toString().padStart(2, '0') + ":" + remainingMinutes.toString().padStart(2, '0'));
        }

        function showCarChargingData(data_controls) {
            // car charging - current states of EVCC
            let evcc_mode = data_controls["evcc"]["charging_mode"];
            let evcc_state = data_controls["evcc"]["charging_state"];

            document.getElementById('evcc_mode').innerText = getChargingColorAndText(evcc_mode, evcc_state).text;
            document.getElementById('evcc_mode').style.color = getChargingColorAndText(evcc_mode, evcc_state).color;
            document.getElementById('evcc_state').style.color = getChargingColorAndText(evcc_mode, evcc_state).color;


            if (evcc_state) {
                document.getElementById('evcc_state').innerText = "charging";
            } else {
                document.getElementById('evcc_state').innerText = "not charging";
            }

            let numOfConnectedVehicles = data_controls["evcc"]["current_sessions"].filter(session => session["connected"]).length;
            if (numOfConnectedVehicles > 1) {
                data_controls["evcc"]["current_sessions"].forEach((session) => {
                    if (session["connected"]) {
                        document.getElementById('ecar_charging_table_single').style.display = "none";
                        document.getElementById('ecar_charging_table_multiple').style.display = "";
                        document.getElementById('ecar_charging_table_off').style.display = "none";

                        let vehicle_name = session["vehicleName"] || "Unknown Vehicle";
                        vehicle_name = vehicle_name.replace(/[^a-zA-Z0-9_]/g, '_'); // sanitize vehicle name for id

                        let displayName = session["vehicleName"] || "Unknown Vehicle";
                        // reduce vehicle name to 10 characters
                        if (displayName.length > 10)
                            displayName = displayName.substring(0, 10) + "...";

                        let row = document.createElement('tr');
                        // set id for the row
                        row.id = 'ecar_charging_row_' + vehicle_name;
                        row.style.color = getChargingColorAndText(session["mode"], session["charging"]).color; // set color based on charging state
                        row.innerHTML = `
                            <td style="text-align: left; cursor: help;" colspan="2" title="name of vehicle in EVCC">
                                <i class="fa-solid fa-car"></i> <span id="ecar_charging_name_${vehicle_name}">${displayName}</span>
                            </td>
                            <td class="valueChange" style="text-align: left; cursor: help;" colspan="2" title="eCar SOC">
                                <span id="ecar_charging_soc_${vehicle_name}">${(session["vehicleSoc"]).toFixed(1)} %</span> 
                                <i class="fa-solid fa-car-battery"></i>
                            </td>
                            <td style="text-align: right; cursor: help;" class="valueChange" id="ecar_charging_charged_${vehicle_name}"
                                title="already charged energy">${(session["chargedEnergy"] / 1000).toFixed(1) + " kWh"}</td>
                            <td style="text-align: right;"><i class="fa-solid fa-right-long"> <i
                                        class="fa-solid fa-bolt"> </i></td>
                            <td style="text-align: right; border-left-width: 1px; border-left-style: solid;"> <i
                                    class="fa-solid fa-road"></i></td>
                            <td style="text-align: right; cursor: help;" class="valueChange" style="text-align: right;"
                                id="ecar_charging_range_${vehicle_name}" title="current vehicle range">${session["vehicleRange"] + " km"}</td>
                        `;
                        // check if the row already exists
                        let existingRow = document.getElementById('ecar_charging_row_' + vehicle_name);
                        if (existingRow) {
                            // update the existing row
                            existingRow.style.color = row.style.color; // update color based on charging state
                            existingRow.innerHTML = row.innerHTML;
                        } else {
                            // append the new row to the table
                            document.getElementById('ecar_charging_table_multiple').appendChild(row);
                        }
                    }
                });
                // cleanup, remove rows for vehicles that are not connected anymore
                let connectedVehicles = data_controls["evcc"]["current_sessions"]
                    .filter(session => session["connected"])
                    .map(session => session["vehicleName"].replace(/[^a-zA-Z0-9_]/g, '_'));
                // console.log("Connected Vehicles: ", connectedVehicles);
                let rows = document.querySelectorAll('#ecar_charging_table_multiple tr');
                rows.forEach(row => {
                    // check if the row id starts with 'ecar_charging_row_' and if the vehicle is not connected anymore
                    // and remove it if not connected
                    if (row.id.startsWith('ecar_charging_row_') && !connectedVehicles.includes(row.id.replace('ecar_charging_row_', ''))) {
                        console.log("Removing row: ", row.id);
                        row.remove();
                    }
                });
                if (rows.length === 0) {
                    document.getElementById('ecar_charging_table_single').style.display = "none";
                    document.getElementById('ecar_charging_table_multiple').style.display = "none";
                    document.getElementById('ecar_charging_table_off').style.display = "";
                }

            } else if (numOfConnectedVehicles == 1) {
                let entryOfConnectedVehicle = data_controls["evcc"]["current_sessions"].find(session => session["connected"]);
                showSingleLoadpoint(entryOfConnectedVehicle);
            }
            else {
                document.getElementById('ecar_charging_table_single').style.display = "none";
                document.getElementById('ecar_charging_table_multiple').style.display = "none";
                document.getElementById('ecar_charging_table_off').style.display = "";
            }
        }

        function adjustGridChargePower(delta) {
            const input = document.getElementById("grid_charge_power");
            let newValue = parseFloat(input.value) + delta;
            newValue = Math.max(parseFloat(input.min), Math.min(parseFloat(input.max), newValue));
            input.value = newValue.toFixed(1);
        }

        function menu_controls_override(icons, ac_charge_max, auto_active) {
            const buttons =
                icons.map((icon, index) => {
                    if (index > 2) return; // without special evcc modes
                    //const isDisabled = index === inverter_mode_num;
                    const isDisabled = false;
                    return '<button id="mode_' + index + '" class="button" style="' +
                        'cursor: ' + (isDisabled ? 'not-allowed' : 'pointer') + '; ' +
                        'font-size: 0.8em; padding: 0.15em 0.3em; margin: 10px; color: ' + (isDisabled ? 'gray' : icon.color) + '; ' +
                        'transition: color 0.3s; background-color: ' + (isDisabled ? '#333' : 'rgb(58, 58, 58)') + '; border-radius: 10px; border: 1px solid ' + (isDisabled ? 'gray' : icon.color) + ';"' +
                        (isDisabled ? ' disabled' : ' onmouseover="this.style.color=\'white\'" onmouseout="this.style.color=\'' + icon.color + '\'" onmousedown="this.style.color=\'#000000\'" ' +
                            'onmouseup="this.style.color=\'' + icon.color + '\'" onclick="handleModeChange(' + index + ')"') + '>' +
                        '<i class="fa-solid ' + icon.icon + '"></i>' +
                        '</button>'
                }).join('') +
                (auto_active ?
                    '<br><span style="font-size: x-small; margin: 40px;"><i>Back To Automatic</i></span><br>' +
                    '<button id="mode_auto" class="button" style="' +
                    'font-size: 0.8em; padding: 0.15em 0.3em; margin: 10px; color: green; transition: color 0.3s; background-color: rgb(58, 58, 58); ' +
                    'border-radius: 10px; border: 1px solid grey;cursor: pointer;' +
                    ' onmouseover="this.style.color=\'white\'" onmouseout="this.style.color=\'green\'" onmousedown="this.style.color=\'#000000\'" ' +
                    'onmouseup="this.style.color=\'green\'" onclick="handleModeChange(\'-2\')"' +
                    '>' +
                    '<i class="fa-solid fa-clock-rotate-left"></i></i></button>' : ''
                );

            const duration_entry =
                '<select id="duration_time" style="padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; background-color: #444; color: white;">' +
                Array.from({ length: 48 }, (_, i) => {
                    const hours = Math.floor((i + 1) / 2);
                    const minutes = ((i + 1) % 2) * 30;
                    const timeLabel = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    return `<option value="${timeLabel}" ${hours === 2 && minutes === 0 ? 'selected' : ''}>${timeLabel}</option>`;
                }).join('') +
                '</select>';
            const ac_charge_power =
                '<div style="display: flex; justify-content: center; align-items: center; margin-top: 10px; padding-bottom: 10px;">' +
                '<button onclick="adjustGridChargePower(-0.1)" style="padding: 10px; font-size: 1em; margin-right: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #444; color: white;' +
                'transition: color 0.3s;" ' +
                'onmouseover="this.style.color=\'gray\'" onmouseout="this.style.color=\'white\'" onmousedown="this.style.backgroundColor=\'lightblue\'" onmouseup="this.style.color=\'white\';this.style.backgroundColor=\'#444\'"' +
                'ontouchstart="this.style.backgroundColor=\'lightblue\'" ontouchend="this.style.color=\'white\';this.style.backgroundColor=\'#444\'"' +
                '">-</button>' +
                '<input id="grid_charge_power" type="number" step="0.25" min="0.5" max="' + ac_charge_max.toFixed(1) + '" value="' + ac_charge_max.toFixed(1) + '" style="padding: 10px; font-size: 1em; text-align: center; width: 1.4em; border-radius: 5px; border: 1px solid #ccc; background-color: #444; color: white;">' +
                '<button onclick="adjustGridChargePower(0.1)" style="padding: 10px; font-size: 1em; margin-left: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #444; color: white;"' +
                'transition: color 0.3s;" ' +
                'onmouseover="this.style.color=\'gray\'" onmouseout="this.style.color=\'white\'" onmousedown="this.style.backgroundColor=\'lightblue\'" onmouseup="this.style.color=\'white\';this.style.backgroundColor=\'#444\'"' +
                'ontouchstart="this.style.backgroundColor=\'lightblue\'" ontouchend="this.style.color=\'white\';this.style.backgroundColor=\'#444\'"' +
                '>+</button>' +
                //                '<span style="font-size: 1.5em; padding-left: 5px;"> kW</span>' +
                '</div>';
            const content =
                '<div style="font-size: 2em;">' +
                buttons +
                '</div>' +
                "<hr style='border-color: rgba(44, 44, 44, 0.596);'>" +
                'Duration <br>' +
                '<div style="display: flex; justify-content: center; align-items: center; margin-top: 10px; padding-bottom: 10px;">' +
                duration_entry +
                '</div>' +
                "<hr style='border-color: rgba(44, 44, 44, 0.596);'>" +
                'Grid Charge Power (kW)<br>' +
                ac_charge_power;
            overlayMenu("Override Current Controls", content);
        }

        async function showCurrentData() {
            //console.log("------- showCurrentControls -------");
            const data_controls = await fetch_eos_ha_Data("current_controls.json");
            showCarChargingData(data_controls);

            inverter_mode_text = data_controls["current_states"]["inverter_mode"];
            inverter_mode_num = data_controls["current_states"]["inverter_mode_num"];
            //inverter_mode_num = 5; // for testing
            override_active = data_controls["current_states"]["override_active"];
            override_end_time = data_controls["current_states"]["override_end_time"];
            if (override_active) {
                inverter_mode_text = '<i class="fa-solid fa-triangle-exclamation"></i> ' + inverter_mode_text;
                document.getElementById('control_ac_charge_desc').innerText = "Override Active";
                document.getElementById('control_ac_charge_desc').style.color = "orange";
                const overrideEndTimeFormatted = new Date(override_end_time * 1000).toLocaleString(navigator.language, { hour: '2-digit', minute: '2-digit' });
                document.getElementById('control_ac_charge').innerText = "until " + overrideEndTimeFormatted;
                document.getElementById('control_ac_charge').style.color = "orange";
                if (inverter_mode_num === 0) {
                    document.getElementById('control_dc_charge_desc').innerText = "AC Charge Power";
                    document.getElementById('control_dc_charge').innerText = (data_controls["current_states"]["current_ac_charge_demand"] / 1000).toFixed(1) + " kW";
                } else if (inverter_mode_num === 2) {
                    document.getElementById('control_dc_charge_desc').innerText = "DC Charge Power";
                    document.getElementById('control_dc_charge').innerText = (data_controls["current_states"]["current_dc_charge_demand"] / 1000).toFixed(1) + " kW";
                } else {
                    document.getElementById('control_dc_charge_desc').innerText = "";
                    document.getElementById('control_dc_charge').innerText = "";
                }
                document.getElementById('control_discharge_allowed_desc').innerText = "";
                document.getElementById('control_discharge_allowed').innerText = "";
                document.getElementById('current_controls_box').style.border = "1px solid orange";
            } else {
                inverter_mode_text = inverter_mode_text.replace("MODE ", "");
                document.getElementById('control_ac_charge_desc').innerText = "AC Charge";
                document.getElementById('control_ac_charge_desc').style.color = "";
                document.getElementById('control_ac_charge').innerText = (data_controls["current_states"]["current_ac_charge_demand"] / 1000).toFixed(1) + " kW";
                document.getElementById('control_ac_charge').style.color = "";
                document.getElementById('control_dc_charge_desc').innerText = "DC Charge";
                document.getElementById('control_dc_charge').innerText = (data_controls["current_states"]["current_dc_charge_demand"] / 1000).toFixed(1) + " kW";
                document.getElementById('control_discharge_allowed_desc').innerText = "Discharge allowed";
                document.getElementById('control_discharge_allowed').innerText = (data_controls["current_states"]["current_discharge_allowed"] === true ? "Yes" : "No");
                document.getElementById('current_controls_box').style.border = "";
            }

            document.getElementById('control_overall').innerHTML = inverter_mode_text.replace("MODE ", "");
            document.getElementById('battery_soc').innerText = data_controls["battery"]["soc"] + " %";
            // set battery icon
            document.getElementById('battery_icon_main').innerHTML = getBatteryIcon(data_controls["battery"]["soc"]);
            document.getElementById('current_max_charge_dyn').innerHTML = "<i>" + (data_controls["battery"]["max_charge_power_dyn"] / 1000).toFixed(2) + " kW</i>";
            // set battery usable energy
            document.getElementById('battery_usable_capacity').innerHTML = '<i class="fa-solid fa-database"></i> ' + (data_controls["battery"]["usable_capacity"] / 1000).toFixed(1) + ' <span style="font-size: 0.6em;">kWh</span>';
            document.getElementById('battery_usable_capacity').title = "usable capacity: " + (data_controls["battery"]["usable_capacity"] / 1000).toFixed(1) + " kWh";

            // dependent on inverter mode show the icon
            //0: "MODE_CHARGE_FROM_GRID",
            //1: "MODE_AVOID_DISCHARGE",
            //2: "MODE_DISCHARGE_ALLOWED",
            //3: "MODE_AVOID_DISCHARGE_EVCC_FAST",
            //4: "MODE_DISCHARGE_ALLOWED_EVCC_PV",
            //5: "MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV",

            const iconElement = document.getElementById('current_header_right');
            iconElement.innerHTML = ""; // Clear previous content

            const icons = [
                { icon: "fa-plug-circle-bolt", color: COLOR_MODE_CHARGE_FROM_GRID, title: "Charge from grid" },
                { icon: "fa-lock", color: COLOR_MODE_AVOID_DISCHARGE, title: "Avoid discharge" },
                { icon: "fa-battery-half", color: COLOR_MODE_DISCHARGE_ALLOWED, title: "Discharge allowed" },
                { icon: "fa-charging-station", color: COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST, title: "Avoid discharge due to e-car fast charge" },
                { icon: "fa-charging-station", color: COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV, title: "Discharge allowed during e-car charging in pv mode" },
                { icon: "fa-charging-station", color: COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV, title: "Discharge allowed during e-car charging in min+pv mode" }
            ];
            const { icon, color, title } = icons[inverter_mode_num] || {};
            iconElement.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            iconElement.style.color = color || "";
            iconElement.title = title || "";

            if (override_active) {
                iconElement.innerHTML = '<i style="color:orange;" class="fa-solid fa-triangle-exclamation"></i> ' + iconElement.innerHTML;
            }

            const updatedMaxChargePower = data_controls["battery"]["max_charge_power_dyn"] / 1000;
            newListener = function () {
                console.log("Override active: " + override_active + " - Max charge power: " + updatedMaxChargePower);
                menu_controls_override(icons, updatedMaxChargePower, override_active);
            };

            // Remove the old listener if it exists
            if (menuControlEventListener) {
                iconElement.removeEventListener('click', menuControlEventListener);
            }

            // Add the new listener
            menuControlEventListener = newListener;
            iconElement.addEventListener('click', menuControlEventListener);


            // energy optimization - last result received
            const timestamp_last_run = new Date(data_controls.state.last_response_timestamp);
            const timestamp_next_run = new Date(data_controls.state.next_run);
            const timestamp_last_run_formatted = timestamp_last_run.toLocaleString(navigator.language, {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('timestamp_last_run').innerText = timestamp_last_run_formatted;
            document.getElementById('timestamp_last_run').title = "last run";
            let time_to_next_run = Math.floor((timestamp_next_run - new Date()) / 1000);
            let minutes = Math.floor(Math.abs(time_to_next_run) / 60); // Correct calculation for minutes
            let seconds = Math.abs(time_to_next_run % 60);
            if (time_to_next_run < 0) {
                document.getElementById('timestamp_next_run').style.color = "lightgreen";
                // add alt text to the time field
                document.getElementById('timestamp_next_run').title = "current optimization running for " + minutes.toString().padStart(2, '0') + " min and " + seconds.toString().padStart(2, '0') + " sec";
            } else {
                document.getElementById('timestamp_next_run').style.color = "orange";
                document.getElementById('timestamp_next_run').title = "next optimization run in " + minutes.toString().padStart(2, '0') + " min and " + seconds.toString().padStart(2, '0') + " sec";
            }
            document.getElementById('timestamp_next_run').innerText = minutes.toString().padStart(2, '0') + ":" + seconds.toString().padStart(2, '0') + " min";

            // display current eos connect version
            document.getElementById('version_overlay').innerText = "EOS connect version: " + data_controls["eos_ha_version"];

            document.getElementById('current_header_left').innerHTML = '<i class="fa-solid fa-circle-info"></i>'; // + " " + data_controls["eos_ha_version"];
            document.getElementById('current_header_left').title = "EOS connect version: " + data_controls["eos_ha_version"];
            document.getElementById('current_header_left').addEventListener('click', function () {
                overlayMenu(
                    "version",
                    '<i style="font-size: smaller;">currently installed:</i><br><br>' + data_controls["eos_ha_version"] + "<br><br>" +
                    "<hr style='border-color: rgba(44, 44, 44, 0.596);'>" +
                    '<div style="font-size: 2em;">' +
                    '<a href="https://github.com/rockinglama/eos-ha" target="_blank" style="padding-right: 20px; color: inherit; onmousedown="this.style.color=\'#551A8B\'" onmouseup="this.style.color=\'inherit\'""><i class="fa-brands fa-square-github"></i></a>' +
                    '<a href="https://github.com/rockinglama/ha_addons/blob/master/eos_ha/CHANGELOG.md" target="_blank"  style="padding-right: 20px; color: inherit; onmousedown="this.style.color=\'#551A8B\'" onmouseup="this.style.color=\'inherit\'""><i class="fa-solid fa-file-invoice"></i></a>' +
                    '<a href="https://github.com/rockinglama/eos-ha/issues" target="_blank"  style="color: inherit; onmousedown="this.style.color=\'#551A8B\'" onmouseup="this.style.color=\'inherit\'""><i class="fa-solid fa-bug"></i></a>' +
                    "</div>"
                );
            });
        }

        function handleModeChange(mode) {
            const duration = document.getElementById('duration_time').value;
            const gridChargePower = document.getElementById('grid_charge_power').value;
            const data_controls = { "mode": mode, "duration": duration, "grid_charge_power": parseFloat(gridChargePower) };
            //console.log("handleModeChange", data_controls);
            setOverrideControl(data_controls)
                .then((result) => {
                    //console.log("Override control set successfully:", result);
                    closeOverlayMenu();
                    overlayMenu('<span style="color:orange;">Success</span>', "Mode changed successfully.", false);
                    setTimeout(() => {
                        closeOverlayMenu(false);
                    }, 2000); // Close the overlay after 2 seconds
                })
                .catch((error) => {
                    overlayMenu("Error", `Failed to change mode: ${error.message}`);
                    setTimeout(() => {
                        overlayMenu("", "");
                    }, 2000); // Close the overlay after 2 seconds
                });
        }

        function showStatistics(data_request, data_response) {
            // set the values for solar yield today and tomorrow
            let yield_today = data_request["ems"]["pv_prognose_wh"].slice(0, 24).reduce((acc, value) => acc + value, 0) / 1000;
            let yield_tomorrow = data_request["ems"]["pv_prognose_wh"].slice(24, 48).reduce((acc, value) => acc + value, 0) / 1000;
            document.getElementById('statistics_header_left').innerHTML = '<i class="fa-solid fa-solar-panel"></i> ' + yield_today.toFixed(1) + ' <span style="font-size: 0.6em;">kWh</span>';
            document.getElementById('statistics_header_left').title = "Solar yield for today";
            document.getElementById('statistics_header_right').innerHTML = + yield_tomorrow.toFixed(1) + ' <span style="font-size: 0.6em;">kWh</span>' + ' <i class="fa-solid fa-solar-panel"></i> ';
            document.getElementById('statistics_header_right').title = "Solar yield for tomorrow";

            // set expense and income for today and tomorrow
            expense_data = data_response["result"]["Kosten_Euro_pro_Stunde"];
            income_data = data_response["result"]["Einnahmen_Euro_pro_Stunde"];
            feed_in_data = data_response["result"]["Netzeinspeisung_Wh_pro_Stunde"];

            let currentHour = new Date(data_response["timestamp"]).getHours(); // ✅ Use server time
            let expense_today = expense_data.slice(0, 24 - currentHour).reduce((acc, value) => acc + value, 0).toFixed(2);
            document.getElementById('expense_summary').innerText = expense_today + " €";
            document.getElementById('expense_summary').title = "Expense for the rest of the day";

            // set income for rest of the day
            let income_today = income_data.slice(0, 24 - currentHour).reduce((acc, value) => acc + value, 0).toFixed(2);
            document.getElementById('income_summary').innerText = income_today + " €";
            document.getElementById('income_summary').title = "Income for the rest of the day";

            // set feed in for rest of the day
            let feed_in_today = feed_in_data.slice(0, 24 - currentHour).reduce((acc, value) => acc + value, 0) / 1000;
            document.getElementById('feed_in_summary').innerText = feed_in_today.toFixed(1) + " kWh";
            document.getElementById('feed_in_summary').title = "Feed in for the rest of the day";

        }

        function showSchedule(data_request, data_response) {
            //console.log("------- showSchedule -------");
            var serverTime = new Date(data_response["timestamp"]);
            var currentHour = serverTime.getHours();
            var discharge_allowed = data_response["discharge_allowed"];
            var ac_charge = data_response["ac_charge"];

            // Add timezone indicator to schedule header
            document.getElementById('load_schedule_header').innerHTML =
                ` Schedule next 24 hours <small>(Local Time)</small>`;

            ac_charge = ac_charge.map((value, index) => value * max_charge_power_w);
            var priceData = data_response["result"]["Electricity_price"];
            var expenseData = data_response["result"]["Kosten_Euro_pro_Stunde"];
            var incomeData = data_response["result"]["Einnahmen_Euro_pro_Stunde"];

            // clear all entries in div discharge_scheduler
            var tableBody = document.querySelector("#discharge_scheduler .table-body");
            tableBody.innerHTML = '';

            priceData.forEach((value, index) => {
                if (index > 23) return;

                if ((index + 1) % 4 === 0 && (index + 1) !== 0) {
                    var row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.borderBottom = "1px solid #707070";
                    row.style.height = "5px";
                    tableBody.appendChild(row); // Append the row to the table body
                    var row = document.createElement('div');
                    row.className = 'table-row';
                    row.style.height = "5px";
                    tableBody.appendChild(row); // Append the row to the table body
                }

                var row = document.createElement('div');
                row.className = 'table-row';

                var cell1 = document.createElement('div');
                cell1.className = 'table-cell';
                // cell1.innerHTML = ((index + currentHour) % 24) + ":00";
                const labelTime = new Date(serverTime.getTime() + (index * 60 * 60 * 1000));
                cell1.innerHTML = labelTime.getHours().toString().padStart(2, '0') + ":00";

                cell1.style.textAlign = "right";
                row.appendChild(cell1);

                var cell2 = document.createElement('div');
                cell2.className = 'table-cell';
                const buttonDiv = document.createElement('div');
                buttonDiv.style.border = "1px solid #ccc";
                buttonDiv.style.borderRadius = "5px";
                buttonDiv.style.borderColor = "darkgray";
                buttonDiv.style.width = "50px";
                buttonDiv.style.display = "inline-block";
                buttonDiv.style.textAlign = "center";

                if (index === 0 && inverter_mode_num > 2) {
                    // override first hour - if eos connect overriding eos
                    if (inverter_mode_num === 3) { // MODE_AVOID_DISCHARGE_EVCC_FAST
                        //buttonDiv.style.backgroundColor = "#3399FF";
                        buttonDiv.style.color = COLOR_MODE_AVOID_DISCHARGE_EVCC_FAST;
                        buttonDiv.innerHTML = " <i class='fa-solid fa-charging-station'></i> <i class='fa-solid fa-lock'></i> ";
                    } else if (inverter_mode_num === 4) { // MODE_DISCHARGE_ALLOWED_EVCC_PV
                        //buttonDiv.style.backgroundColor = "#3399FF";
                        buttonDiv.style.color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_PV;
                        buttonDiv.innerHTML = " <i class='fa-solid fa-charging-station'></i> <i class='fa-solid fa-battery-half'></i> ";
                    } else if (inverter_mode_num === 5) { //MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV
                        //buttonDiv.style.backgroundColor = "rgb(255, 144, 144)";
                        buttonDiv.style.color = COLOR_MODE_DISCHARGE_ALLOWED_EVCC_MIN_PV;
                        buttonDiv.innerHTML = " <i class='fa-solid fa-charging-station'></i> <i class='fa-solid fa-battery-half'></i> ";
                    }
                } else if (discharge_allowed[(index + currentHour)] === 1) {
                    //buttonDiv.style.backgroundColor = "grey";
                    buttonDiv.style.color = COLOR_MODE_DISCHARGE_ALLOWED;
                    buttonDiv.innerHTML = "<i class='fa-solid fa-battery-half'></i>";
                } else if (ac_charge[(index + currentHour)]) {
                    //buttonDiv.style.backgroundColor = color_bat_grid_charging;
                    buttonDiv.style.color = COLOR_MODE_CHARGE_FROM_GRID;
                    let acChargeValue = ac_charge[(index + currentHour)] === 0 ? "" : (ac_charge[(index + currentHour)] / 1000).toFixed(1) + '<span style="font-size: xx-small;"> kWh<span>';
                    buttonDiv.innerHTML = "<i class='fa-solid fa-plug-circle-bolt'></i> " + acChargeValue;
                    buttonDiv.style.padding = "0 10px";
                    buttonDiv.style.width = "";
                } else {
                    //buttonDiv.style.backgroundColor = "";
                    buttonDiv.style.color = COLOR_MODE_AVOID_DISCHARGE;
                    buttonDiv.innerHTML = "<i class='fa-solid fa-lock'></i>";
                }

                cell2.appendChild(buttonDiv);
                cell2.style.textAlign = "center";
                row.appendChild(cell2);

                var cell3 = document.createElement('div');
                cell3.className = 'table-cell';
                cell3.innerHTML = (priceData[index] * 100000).toFixed(1);
                cell3.style.textAlign = "center";
                row.appendChild(cell3);

                var cell4 = document.createElement('div');
                cell4.className = 'table-cell';
                cell4.innerHTML = (expenseData[index]).toFixed(2);
                cell4.style.textAlign = "center";
                row.appendChild(cell4);

                var cell5 = document.createElement('div');
                cell5.className = 'table-cell';
                cell5.innerHTML = (incomeData[index]).toFixed(2);
                cell5.style.textAlign = "center";
                row.appendChild(cell5);

                tableBody.appendChild(row);
            });
        }

        function handlingErrorInResponse(data_response) {

            if (!data_response || !data_response["result"] || !data_response["result"]["Last_Wh_pro_Stunde"] || data_response["result"]["Last_Wh_pro_Stunde"].length === 0) {
                document.getElementById('overlay').style.display = 'flex';
                if (data_response["error"]) {
                    if (data_response["error"].includes("Request timed out")) {
                        document.getElementById('waiting_text').innerText = "No processing possible - connection to EOS server timed out";
                        document.getElementById('waiting_error_text').innerText = "Error: " + data_response["error"];
                    }
                    else if (data_response["error"].includes("422 Client Error: Unprocessable Entity")) {
                        document.getElementById('waiting_text').innerText = "Check your configuration! - EOS cannot process the request...";
                        document.getElementById('waiting_error_text').innerText = "Error: " + data_response["error"];
                    }
                    else {
                        document.getElementById('waiting_text').innerText = "No data available...";
                        document.getElementById('waiting_error_text').innerText = "no detailed error information available - error message: " + data_response["error"];
                    }
                } else if (data_response["status"]) {
                    document.getElementById('waiting_text').innerText = data_response["status"];
                    document.getElementById('waiting_error_text').innerText = data_response["message"];
                }
                else {
                    document.getElementById('waiting_text').innerText = "Waiting for first data...";
                    document.getElementById('waiting_error_text').innerText = "";
                }
                return true;
            }
        }

        async function setOverrideControl(data_controls) {
            try {
                const response = await fetch('controls/mode_override', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data_controls)
                });

                if (!response.ok) {
                    const errorMessage = await response.text();
                    throw new Error(`Error ${response.status}: ${errorMessage}`);
                }

                return await response.json(); // Return the parsed JSON response
            } catch (error) {
                console.error("Failed to set override control:", error);
                throw error; // Re-throw the error to handle it in the calling function
            }
        }
        // function to observe changed values of doc elements from class "valueChange" and animate the change
        Array.from(document.getElementsByClassName("valueChange")).forEach(function (element) {
            const observer = new MutationObserver(function (mutationsList, observer) {
                const elem = mutationsList[0].target;
                // elem.classList.add("animateValue");
                elem.style.color = "black"; //"#2196f3"; //lightgreen
                //elem.style.fontSize = "95%";
                setTimeout(function () {
                    elem.style.color = "inherit";// "#eee";
                    //elem.style.fontSize = "100%";
                }, 1000);

            });
            observer.observe(element, { characterData: false, childList: true, attributes: false });
        });

        async function init() {
            // base chart
            if (TEST_MODE) {
                var data_request = await fetch_eos_ha_Data("optimize_request.test.json");
                var data_response = await fetch_eos_ha_Data("optimize_response.test.json");
            } else {
                var data_request = await fetch_eos_ha_Data("optimize_request.json");
                var data_response = await fetch_eos_ha_Data("optimize_response.json");
            }
            // const data_request = await fetch_eos_ha_Data("optimize_request.json");
            // max_charge_power_w according to optimize_request api version
            max_charge_power_w = data_request["pv_akku"] && data_request["pv_akku"].hasOwnProperty("max_ladeleistung_w") ? data_request["pv_akku"]["max_ladeleistung_w"] : data_request["pv_akku"] ? data_request["pv_akku"]["max_charge_power_w"] : 0;

            // const data_response = await fetch_eos_ha_Data("optimize_response.json");

            await showCurrentData();

            // error handling
            if (handlingErrorInResponse(data_response)) {
                return;
            }

            if (chartInstance) {
                updateChart(data_request, data_response);
                document.getElementById('overlay').style.display = 'none';
            } else {
                createChart(data_request, data_response);
                document.getElementById('overlay').style.display = 'none';
            }

            showStatistics(data_request, data_response);
            showSchedule(data_request, data_response);
            setBatteryChargingData(data_response);
            updateLegendVisibility();
        }

        init();
        setInterval(init, 1000);
    </script>
</body>

</html>